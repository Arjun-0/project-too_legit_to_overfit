---
title: "Project proposal"
author: "Too Legit to Overfit"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(pander)
library(here)
```

```{r load-data, message = FALSE}
board_games <- read_csv(here("data/board_games.csv"))
```

## 1. Introduction

The dataset we are looking at is a collection of board games from Board Game Geeks, which is a crowd-sourced board game review platform. The variables in the dataset are:

We would like to use this dataset to analyse the differences between different categories of board game, in terms of playtime, popularity, and ratings.

## 2. Data

```{r dimensions}
glimpse(board_games)
```


## 3. Data analysis plan

We will try to look for correlations between category and popularity, number of ratings, and playtime. The most common categories are

```{r popular-categories}
board_games_splitcats <- board_games %>% 
  mutate(categories = str_split(category, ","))

popular_categories <- board_games_splitcats %>%
  pull(categories) %>%
  unlist %>%
  as_tibble %>%
  count(value) %>%
  arrange(desc(n)) %>%
  head(6)

popular_categories %>%
  pander

popular_categories <- pull(popular_categories, value)
```

```{r filter-top-cats, eval = FALSE}
list_intersect <- function(a, b) {
  do_intersect = FALSE
  for (value in a) {
    if (value %in% b) {
      do_intersect = TRUE
    }
  }
  do_intersect
}

rows = c()
for (row in 1:nrow(board_games_splitcats)) {
  game_categories <- unlist(board_games_splitcats$categories[row])
  if (list_intersect(game_categories, popular_categories)) {
    rows <- append(rows, board_games_splitcats$game_id[row])
  }
}

board_games_topcats <- board_games_splitcats %>% 
  filter(game_id %in% rows) 
```

```{r filter-top-cats-alt}
board_games_topcats <- board_games_splitcats %>% 
  filter(map_lgl(categories, ~any(popular_categories %in% .x)))

# Note this df has same name as above df because is exactly same df. Should choose preferred method and get rid of other.
```

We can investigate the changes in quality of different categories of games. For example, investigating how the quality of board games in the six most common categories changes over time. As a measure of quality, we use the mean rating given to a game in that category (that is, the sum of all ratings in a category (in a given year) divided by the total number of such ratings). 

```{r top-cats-over-time, message = FALSE, warning = FALSE}
av_annual_rating <- function(df, cat = NULL) {
  {if(!is.null(cat)) {
    df %>% filter(map_lgl(categories, ~cat %in% .x))
  } else {
    df
  }} %>% 
  group_by(year_published) %>% 
  summarise(av_annual_rating = sum(average_rating * users_rated) / sum(users_rated))
}
# finds average rating (of a category (cat) if given) of board games in dataframe given (df) for each year in which a board game of that category was published. Output is a dataframe. df must have columns `year published`, `categories` (a `list` of categories), `average_rating` and `year_published`. 

cats <- map(popular_categories, ~av_annual_rating(df = board_games_topcats, cat = .))

cat_ratings <- reduce(cats, ~full_join(.x,.y, by = "year_published")) %>% 
  arrange(year_published)

if(any(is.na(popular_categories))) {
  popular_categories[[which(is.na(popular_categories))]] <- "not_categorised"
} 

names(cat_ratings) <- c("year_published", popular_categories)
```

```{r top-cats-over-time-plot, warning = FALSE}
cat_ratings %>% 
  pivot_longer(cols = 2:ncol(cat_ratings), names_to = "category", values_to = "av_rating") %>% 
  ggplot(aes(x = year_published, y = av_rating, colour = category)) + 
  geom_line() + 
  labs(
    x = "Year published", 
    y = "Mean annual category rating", 
    colour = "Category", 
    title = "Average ratings of the 6 most popular game categories by year published"
  ) + 
  scale_color_viridis_d() +
  theme_minimal()
```

This plot indicates a fairly strong association between mean ratings (of games in the six most popular categories) and time. That is, more recent games (regardless of category) are rated more highly on average than older games. We can investigate further whether this is something universal across all categories, and whether any other variables such as changes in playtime or game mechanics, for example, could be an influence. This will require producing similar plots to investigate relationships of variables over time, as well as calculating statistics such as correlation coefficients to investigate relationships between variables. 

```{r total-ratings-over-time, message = FALSE}
board_games_splitcats %>% 
  av_annual_rating() %>% 
  ggplot(aes(x = year_published, y = av_annual_rating)) +
  geom_line() +
  labs(
    x = "Year published",
    y = "Mean annual rating",
    title = "Average ratings of board games by year published"
  ) +
  scale_color_viridis_d() +
  theme_minimal()
```

Indeed the overall trend for board game ratings has been an increase in ratings for more recently published games. 
